<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Style Sense</title>
    <!-- Google Fonts - Montserrat (for titles), Poppins (for general text) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;900&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS Variables for consistent theming */
        :root {
            --primary-color: #7F00FF; /* Electric Violet */
            --secondary-color: #E100FF; /* Neon Pink */
            --accent-color: #00DBDE; /* Aqua */
            --text-color-light: #E0F7FA;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #0D0D1A;
            color: var(--text-color-light);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        .background-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(-45deg, #1f0122, #0d0d1a, #110d18, #0a010c);
            background-size: 400% 400%;
            animation: backgroundGradientAnimation 25s ease infinite;
            z-index: -1;
        }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Animations */
        @keyframes backgroundGradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes glowing-border {
            0% { box-shadow: 0 0 5px var(--primary-color), 0 0 10px var(--secondary-color), 0 0 15px var(--primary-color); }
            50% { box-shadow: 0 0 20px var(--accent-color), 0 0 30px var(--secondary-color), 0 0 40px var(--accent-color); }
            100% { box-shadow: 0 0 5px var(--primary-color), 0 0 10px var(--secondary-color), 0 0 15px var(--primary-color); }
        }

        .card {
            animation: fadeInScale 0.7s ease-out forwards;
            animation: glowing-border 4s infinite alternate;
        }

        .loading-spinner {
            border-top-color: var(--secondary-color);
            animation: spin 1s linear infinite;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-out {
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4 relative">

    <!-- Background Gradient Layer -->
    <div class="background-gradient"></div>

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 flex flex-col items-center justify-center text-white text-center z-50 bg-[#0D0D1A] transition-opacity duration-1000 ease-in-out">
        <h1 class="text-6xl md:text-8xl font-black mb-4 animate-pulse" style="font-family: 'Montserrat', sans-serif;">Style Sense</h1>
        <p class="text-xl md:text-3xl italic px-4 animate-fade-in">"Your vision, styled."</p>
    </div>

    <!-- Main App Content -->
    <div id="app-content" class="container mx-auto card glass-morphism rounded-3xl p-6 md:p-10 text-center opacity-0 transition-opacity duration-1000">
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-4" style="font-family: 'Montserrat', sans-serif;">Style Sense</h1>
        <p class="text-lg text-white mb-8">
            Upload a clear photo of your face to get a personalized hairstyle suggestion.
        </p>

        <!-- Image Upload Input -->
        <label for="file-upload" class="inline-flex cursor-pointer bg-fuchsia-500 hover:bg-fuchsia-600 text-white font-semibold py-3 px-6 rounded-full transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-1">
            Choose Image
            <input id="file-upload" type="file" accept="image/*" class="hidden">
        </label>

        <!-- Image Preview and Controls -->
        <div id="preview-controls-container" class="mt-8 hidden flex flex-col items-center">
            <div id="image-preview-container" class="w-full max-w-sm mx-auto">
                <img id="image-preview" src="#" alt="Image Preview" class="w-full h-auto rounded-xl shadow-lg">
            </div>
            <button id="generate-button" class="mt-6 hidden bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-full transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-1">
                Get Recommendation
            </button>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="hidden flex flex-col items-center mt-8">
            <div class="loading-spinner w-12 h-12 border-4 border-gray-200 rounded-full"></div>
            <p id="loading-text" class="mt-4 text-white font-medium">Analyzing image...</p>
        </div>

        <!-- Results Container -->
        <div id="results-container" class="hidden mt-8 text-left space-y-8">
            <!-- Recommendation Text -->
            <div id="recommendation-text-container" class="bg-white bg-opacity-10 p-6 rounded-2xl shadow-inner fade-in">
                <h2 class="text-2xl font-bold text-white mb-4">Our Recommendation</h2>
                <p id="recommendation-text" class="text-white text-base md:text-lg"></p>
                <!-- Image Generation Button -->
                <button id="generate-image-button" class="mt-6 hidden bg-violet-500 hover:bg-violet-600 text-white font-semibold py-3 px-6 rounded-full transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-1">
                    Visualize Hairstyle
                </button>
            </div>
            <!-- Generated Image -->
            <div id="generated-image-container" class="hidden mt-8 text-center fade-in">
                <h2 class="text-2xl font-bold text-white mb-4">Visual Hairstyle Suggestion</h2>
                <img id="generated-image" src="#" alt="Generated Hairstyle" class="w-full max-w-sm mx-auto h-auto rounded-xl shadow-lg">
            </div>
        </div>

        <!-- Error Message Box -->
        <div id="error-message" class="hidden mt-8 p-4 bg-red-100 text-red-700 rounded-xl shadow-md">
            <p id="error-text" class="font-medium"></p>
        </div>
    </div>

    <script>
        // DOM elements
        const splashScreen = document.getElementById('splash-screen');
        const appContent = document.getElementById('app-content');
        const fileInput = document.getElementById('file-upload');
        const previewControlsContainer = document.getElementById('preview-controls-container');
        const imagePreview = document.getElementById('image-preview');
        const generateButton = document.getElementById('generate-button');
        const generateImageButton = document.getElementById('generate-image-button');
        const loadingSpinner = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const resultsContainer = document.getElementById('results-container');
        const recommendationText = document.getElementById('recommendation-text');
        const generatedImageContainer = document.getElementById('generated-image-container');
        const generatedImage = document.getElementById('generated-image');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        let uploadedBase64Data = null;
        let lastRecommendation = "";

        // Animate splash screen on window load
        window.onload = () => {
            setTimeout(() => {
                splashScreen.classList.add('fade-out');
                splashScreen.addEventListener('transitionend', () => {
                    splashScreen.style.display = 'none';
                    appContent.classList.remove('opacity-0');
                    appContent.classList.add('opacity-100');
                }, { once: true });
            }, 3000); // Display for 3 seconds
        };

        // Main event listener for file upload
        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            // Clear previous results and errors
            resultsContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');
            recommendationText.innerHTML = '';
            generatedImageContainer.classList.add('hidden');
            generatedImage.src = '';
            generateImageButton.classList.add('hidden');


            // Read the image file and display a preview
            const reader = new FileReader();
            reader.onload = async () => {
                imagePreview.src = reader.result;
                uploadedBase64Data = reader.result.split(',')[1];
                previewControlsContainer.classList.remove('hidden');
                generateButton.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        });

        // Event listener for the "Get Recommendation" button
        generateButton.addEventListener('click', async () => {
            if (!uploadedBase64Data) {
                displayError("Please upload an image first.");
                return;
            }

            // Hide previous results and errors
            resultsContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');
            generateButton.classList.add('hidden');
            generatedImageContainer.classList.add('hidden');
            generatedImage.src = '';
            generateImageButton.classList.add('hidden');


            try {
                loadingText.textContent = "Analyzing image and generating recommendation...";
                loadingSpinner.classList.remove('hidden');

                // Step 1: Get text recommendation
                const recommendation = await getHairstyleRecommendation(uploadedBase64Data);

                if (recommendation.toLowerCase().includes("no face recognized")) {
                    displayError("No face recognized in the image. Please try again with a clear photo of your face.");
                    return;
                }
                
                lastRecommendation = recommendation;
                
                // Show the results container and text recommendation
                resultsContainer.classList.remove('hidden');
                recommendationText.innerHTML = recommendation.replace(/\n/g, '<br>');
                generateImageButton.classList.remove('hidden');

            } catch (err) {
                displayError("An error occurred during generation. Please try again with a different image.");
                console.error("Error during generation:", err);
            } finally {
                loadingSpinner.classList.add('hidden');
                generateButton.classList.remove('hidden');
            }
        });

        // Event listener for the "Generate Hairstyle Image" button
        generateImageButton.addEventListener('click', async () => {
            if (!lastRecommendation) {
                displayError("Please get a text recommendation first.");
                return;
            }

            // Hide previous image and button
            generatedImageContainer.classList.add('hidden');
            generateImageButton.classList.add('hidden');

            try {
                loadingText.textContent = "Creating your hairstyle image...";
                loadingSpinner.classList.remove('hidden');

                const imagePrompt = `Generate a realistic image of a person with the following hairstyle: ${lastRecommendation}. The image should focus on the hairstyle and be clear and high-quality.`;
                const imageDataUrl = await generateHairstyleImage(imagePrompt);

                generatedImage.src = imageDataUrl;
                generatedImageContainer.classList.remove('hidden');
            } catch (err) {
                displayError("An error occurred while generating the image. Please try again.");
                console.error("Image generation error:", err);
            } finally {
                loadingSpinner.classList.add('hidden');
                generateImageButton.classList.remove('hidden');
            }
        });

        async function getHairstyleRecommendation(base64ImageData) {
            const userPrompt = `You are a professional hairstyle consultant. First, determine if a human face is clearly visible in the image. If not, respond with the exact phrase "No face recognized." If a face is visible, then analyze the face shape and features. Do not mention the person's race, age, gender, or any personal details. Based on what you see, provide a concise and helpful hairstyle recommendation. Explain why the hairstyle would be a good fit for the features. Be positive and encouraging.`;
            
            const apiKey = typeof __initial_auth_token !== 'undefined' ? '' : 'AIzaSyB3ZGdPeoTarirWxMY8GeE_e1boLczBJyU'; // Replace with your actual API key
            
            if (apiKey === "" && typeof __initial_auth_token === 'undefined') {
                displayError("API Key is missing. Please add your key to run this locally.");
                throw new Error("API Key is missing. Please add your key to run this locally.");
            }

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: userPrompt },
                            {
                                inlineData: {
                                    mimeType: "image/jpeg",
                                    data: base64ImageData
                                }
                            }
                        ]
                    }
                ],
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API request failed with status: ${response.status}`);
            }

            const result = await response.json();
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

            if (text) {
                return text;
            } else {
                throw new Error("Could not get a text recommendation.");
            }
        }

        async function generateHairstyleImage(prompt) {
            const apiKey = typeof __initial_auth_token !== 'undefined' ? '' : 'AIzaSyB3ZGdPeoTarirWxMY8GeE_e1boLczBJyU'; // Replace with your actual API key
            if (apiKey === "" && typeof __initial_auth_token === 'undefined') {
                displayError("API Key is missing. Please add your key to run this locally.");
                throw new Error("API Key is missing. Please add your key to run this locally.");
            }

            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    responseModalities: ['TEXT', 'IMAGE']
                },
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
            
            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API request failed with status: ${response.status}`);
            }

            const result = await response.json();
            const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

            if (base64Data) {
                return `data:image/png;base64,${base64Data}`;
            } else {
                throw new Error("Could not get a generated image.");
            }
        }

        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) {
                        return response;
                    }
                    console.warn(`Retry attempt ${i + 1}: Received 429 (Too Many Requests). Retrying...`);
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                } catch (error) {
                    console.error(`Fetch attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }

        function displayError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }
    </script>
</body>
</html>
